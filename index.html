<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
  <head>
	<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
	<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
	<META HTTP-EQUIV="Expires" CONTENT="0">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>飘</title>
	<link rel="stylesheet" type="text/css" href="inc/all.css">
    <script language="javascript" src="inc/jq_1_11_1.js" type="text/javascript"></script>
    <script language="javascript" src="inc/underscore.js" type="text/javascript"></script>
    <script language="javascript" src="inc/forum.js" type="text/javascript"></script>
    <script language="javascript" src="inc/set.js" type="text/javascript"></script>
    <script language="javascript" src="inc/msg.js" type="text/javascript"></script>
    <script language="javascript" src="inc/md5.js" type="text/javascript"></script>
    <script language="javascript" src="inc/ubb.js" type="text/javascript"></script>
  </head>
 <body>
	<script language="javascript">

var PFItem = function( owner, name, title, objpg )
{
	var it = this;

	this.Owner = owner;
	this.Name = name;
	this.ObjPg = objpg;

	this.Draw = function()
	{
		var dom = $( '<div class="pfitem" id="' + this.Name + '"><div class="title"><span class="arrow">▷</span>' + title +'<span class="newnum"></span></div><div class="content"></div></div>' );
		this.Owner.children( '#' + this.Name ).remove();
		this.Owner.append( dom );
		dom.data( 'obj', this );
	};

	this.GetTitle = function()
	{
		return $( '#' + this.Name ).children( '.title' );
	}

	this.GetContent = function()
	{
		return $( '#' + this.Name ).children( '.content' );
	}

	this.Close = function()
	{
		var dom = $( '#' + this.Name );
		dom.children( '.content' ).hide( 300 );
		dom.children( '.title' ).children( '.arrow' ).html( '▷' );
		this.ObjPg.hide( 300 );
	};

	this.Open = function()
	{
		var dom = $( '#' + this.Name );
		dom.children( '.content' ).show( 300 );
		dom.children( '.title' ).children( '.arrow' ).html( '◀' );
		this.ObjPg.show( 300 );
	};

	this.Click = function( Map )
	{
		try
		{
			$( '.pfitem:contains(◀)' ).data( 'obj' ).Close();
		}
		catch( e ){}

		this.Open();
	};

	this.Draw();
}

var PeerForum = function()
{
	var pf = this;
	this.Info = { warning: [], error: [], info: [] };

	this.Init = function()
	{
		this.PageIdx = {};
		this.Height = document.documentElement.clientHeight;
  		$( 'td#leftarea>div' ).css( 'height', pf.Height - 35 + 'px' );

		$( window ).resize( function()
		{
  			pf.Height = document.documentElement.clientHeight;
  			//console.log( pf.Height );
  			$( 'td#leftarea>div' ).css( 'height', pf.Height - 35 + 'px' );
		} );

		var ItemBox = $( '#itembox' );
		[
			['message', '消息', 'msgpg', 'InitMsgPg'],
			['forum', '论坛', 'forumpg', 'InitForumPg'],
			['timeline', '时间线', 'timelinepg', 'InitTimeLinePg'],
			['setting', '设置', 'setpg', 'InitSetPg'],
		].forEach( function( data )
		{
			pf.PageIdx[data[0]] = new PFItem( ItemBox, data[0], data[1], $( '#' + data[2] ));
			pf[data[3]]();
		} );

		$( '.pfitem' ).click( function()
		{
			$( this ).data( 'obj' ).Click();
		} );

		$( '.page' ).hide();
		$( '.pfitem>.content' ).hide();
		$( '#forum' ).click();

		this.ChkEnv();
		//this.GetNode();
		//this.GetUser();
		//setTimeout( this.Dida, 5000 );
	};

	this.InitForumPg = function()
	{
		this.Forum = new Forum( this );
		this.Forum.GetNextPage();
	}

	this.InitMsgPg = function(){};
	this.InitTimeLinePg = function(){};
	this.InitSetPg = function(){};

	this.ShowInfo = function()
	{
		var dom = $( '#message' );
		var content = dom.children( '.content' );
		_( ['error', 'warning', 'info'] ).each( function( k )
		{
			_( pf.Info[k] ).each( function( msg )
			{
				var MsgItem = $( '<div></div>' );
				content.append( MsgItem );
				msg.Notice( MsgItem );
			} );
		} );
		dom.children( '.title' ).children( '.newnum' ).html( content.children( 'div' ).length );
	};

	this.ChkLocalNode = function( lcNode )
	{
		if( !lcNode[1] )
		{
			this.Info.warning.push( new PFMessage( 'SetNodeName', lcNode ));
		}

		this.CurNode = lcNode;
	};

	this.ChkLocalUser = function( lcUser )
	{
		if( !lcUser[1] )
		{
			this.Info.error.push( new PFMessage( 'SetUserName', lcUser ));
		}

		this.CurUser = lcUser;
	};

	this.ChkAuthStatus = function( authPubK )
	{
		return 0;
	};

	this.SetAtclLabels = function( atclLabels )
	{
		//console.log( 'SetAtclLabels' );
		var LabelArea = $( '#forum>.content' );
		LabelArea.html( '<div id="alllabelidx">所有话题</div>' );

		$( '#alllabelidx' ).click( function()
		{
			pf.Post( { cmd: 'GetAllTopic' }, 'GetResult' );
		} );

		atclLabels.forEach( function( lb )
		{
			LabelArea.append( '<div class="atcllabel">' + lb + '</div>' );
		} );

		LabelArea.children( '.atcllabel' ).click( function()
		{
			pf.Forum.LabelTopic( $( this ).html());
		} );
	};

	this.SetFollowUsers = function( users )
	{
		var UserArea = $( '#timeline>.content' );
		UserArea.html( '<div id="alluseridx">所有关注用户</div>' );

		$( '#alluseridx' ).click( function()
		{
			pf.Post( { cmd: 'GetAllTimeLine' }, 'GetResult' );
		} );

		users.forEach( function( u )
		{
			UserArea.append( '<div class="atcllabel" title="' + u[1] + '">' + u[0] + '</div>' );
		} );

		UserArea.children( '.atcllabel' ).click( function()
		{
			pf.Post( { cmd: 'GetTimeLine', user: this.attr( 'title' ) }, 'GetResult' );
		} );
	};

	this.ShowNewTopic = function( topic )
	{
		console.log( topic );
		$( '#tpclist>table>tbody>tr:eq(0)' ).after( this.Forum.TopicTR( topic ));
		var NewTR = $( '#tpclist>table>tbody>tr.new' );
		this.Forum.SetAttr( NewTR );
		$( 'span.arrow', NewTR ).click();
		setTimeout( function()
		{
			pf.Forum.ResetNewTpcInput();
			var TreeTR = NewTR.next( 'tr.tree' );
			$( 'span.arrow', TreeTR ).click();
		}, 500 );
	};

	this.ShowAtclPg = function( treeData )
	{
		//console.log( treeData );
		this.Forum.SetTopicData( treeData );
		this.Forum.ShowAtcls( treeData[0], this.Forum.FLOWMODE );
	};

	this.ShowReply = function( rplData )
	{
		console.log( rplData );
		this.Forum.ReplyOK( rplData );		
	};
	
	/*this.SetLike = function( likeData )
	{
		console.log( likeData );
		this.Forum.AddLike( likeData );
	};*/

	this.ExpendTpcTree = function( treeData )
	{
		console.log( treeData );
		this.Forum.SetTopicData( treeData );
		var TreeTR = this.Forum.ShowTree( treeData[0] );

		TreeTR.hide();
		$( '#Topic_' + treeData[0] ).after( TreeTR );
		TreeTR.show( 400 );
	}

	this.AppendTopics = function( topics )
	{
		//console.log( topics );
		var TBody = $( '#tpclist>table>tbody' );
		topics.forEach( function( topic )
		{
			try	{ TBody.append( pf.Forum.TopicTR( topic ));	} catch( e ) {};
		} );

		this.Forum.SetAttr( TBody.children( 'tr.new' ));
		this.Forum.ChkNextPage();
	};

	this.UpdateLabelStr = function( labelData )
	{
		this.Forum.SetLabelStr( labelData );
	};

	this.GetResult = function( rslt )
	{
		//rslt.Labels = ['帖子', '格行', '禁止', '块', '隐现器'];
		//rslt.Follows = [['带删除', 'iggojojp'], ['下划线', '8g7ff6d'], ['表格行', 'yft7f6d5d'], ['页内跳转', 'ou98767df'], ['选择器选项', 'jhgyfdd']];
		console.log( rslt );
		_( {
			 'CurNode': 'ChkLocalNode',
			 'CurUser': 'ChkLocalUser',
			 'AllLabels': 'SetAtclLabels',
			 'Follows': 'SetFollowUsers',
			 'NewTopic': 'ShowNewTopic',
			 'PageTopics': 'AppendTopics',
			 'AtclTree': 'ShowAtclPg',
			 'UpdateLabel': 'UpdateLabelStr',
			 'Reply': 'ShowReply',
			 'ShowTree': 'ExpendTpcTree',

			} ).chain().pairs().each( function( p )
		{
			//console.log( p );
			if( p[0] in rslt )
			{
				var v = rslt[p[0]];
				if( p[1] )
				{
					pf[p[1]]( v );
				}
			}
		} );

		this.ShowInfo();
		//console.log( pf.CurUser, pf.CurNode );
	};

	this.Dida = function()
	{
		this.Post( { cmd: 'Dida' }, 'GetResult' );
		setTimeout( this.Dida, 5000 );
	};

	this.ChkEnv = function()
	{
		this.Post( { cmd: 'ChkEnv' }, 'GetResult' );
	};

	this.GetNode = function()
	{
		this.Post( { cmd: 'GetNode' }, 'GetResult' );
	};

	this.GetUser = function()
	{
		this.Post( { cmd: 'GetUser' }, 'GetResult' );
	};

	this.Post = function( params, dataFunc, errFunc )
	{
		console.log( 'Post', params );
		$.post( '/', params, function( data )
		{
			var Result = JSON.parse( data );
			if( 'error' in Result )
			{
				( errFunc || alert )( Result.error );
			}
			pf[dataFunc]( Result );
		} );
	};

	this.Init();
};

$( function()
{
	new PeerForum();
} );
	</script>
		<div>
			<table class='main' align='center'>
				<tbody>
					<tr>
						<td id='leftarea' valign='top'>
							<div id='forumpg' class='page'>
								<div id='listpg'>
									<div id='newtopic'>
										<div id='newtpcbtn'>发布新话题</div>
										<div id='tpcinput' style='display:none'>
											<table>
												<tbody>
													<tr>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
									<br/><br/>
									<div id='tpclist'>
										<div>话题列表</div>
										<table width='100%'>
											<tbody>
												<tr>
													<th>标题</th>
													<th width='90px' id="firstth" title='排序'>首发</th>
													<th width='50px'>帖数</th>
													<th width='150px' id="lastth" title='排序'><span>↓↓↓</span>最新<span class="query" title="">？</span></th>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
								<div id='atclpg' class='page'>
									<div id='returntolist'>返回话题列表</div>
									<div id='atclarea'></div>
								</div>
							</div>
							<div id='msgpg' class='page'>msgpage</div>
							<div id='timelinepg' class='page'>timelinepg</div>
							<div id='setpg' class='page'>setpg</div>
						</td>
						<td id='rightarea' valign='top'>
							<div id='logo'>PeerForum</div>
							<div id='itembox'></div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
  </body>
</html>
